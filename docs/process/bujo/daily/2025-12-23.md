# Daily Log — 2025-12-23

## What I touched
- Adjusted smart-actor tag tests to treat tag order as unordered and verified a clean build.
- Added tag sources (`tags.yaml`) and a context input builder to feed explicit plot/item/quest tags into smart-actor RAG.
- Implemented SmartActorContextBuilder to merge explicit tags and retrieve history snippets with tests.
- Implemented smart-actor RAG store + spec loader + history retrieval ranking with unit tests.
- Checked in the user-provided Island backstory edit and added game art assets.
- Defined the smart-actor RAG retrieval contract, ranking, and context injection format.
- Added smart-actor backstory + RAG history metadata to the design spec and Mansion roster; updated the generic smart-actor prompt inputs.
- Added a generic smart actor system prompt and a Mansion smart-actor roster with whodunit personas; expanded Mansion actors to include suspects.
- Defined the smart actor architecture (persona, memory, policies, engine boundary) and linked it from design/docs index.
- Reviewed AI runbook/CLI docs against GameCli and agent prompts; updated runbook/checklist for AI-disabled fallback, TranslationOrchestrator validation, and narration fallback; refreshed AI CLI docs/skill and docs index; updated the today/tomorrow/someday list.
- Housekeeping sweep: removed the temporary todo and stray log artifacts; updated the cleaning log.
- Reviewed AI runbook/CLI docs against GameCli and runtime prompts; updated AI docs for prompt locations, AI mode gating, JSON translator output, and narrator output contract.
- Added `docs/reference/skill.md` and the today/tomorrow/someday task list under `docs/process/bujo/`.
- Updated BUJO readme to reference the today/tomorrow/someday list.
- Updated docs index and removed the temporary root `todo.md`.
- Aligned the translator prompt to scanner/command-compiler command shapes and refreshed prompt goldens.
- Loaded per-game crafting recipes in GameCli and ensured empty recipe sets do not fall back to island defaults.
- Replaced manual HOW CRAFT string trimming with CommandScanner token handling.
- Printed crafting and HOW CRAFT summaries directly in AI mode to avoid repeated scene narration and preserve lists.
- Removed tracked `target/` artifacts from git after adding `target/` to `.gitignore`.
- Prioritized today’s Island Adventure 10/10 kernel-mechanics checklist in the BUJO list.
- Updated the BUJO schedule for today (Island), tomorrow (Mansion/Western/Spy), and someday (My Adventure).
- Added loop runtime infrastructure (world clock, reset flow, persistent notebook snapshotting) and a loop config loader for Island Adventure.
- Added trigger YAML loader + trigger engine with ON_TAKE/ON_ENTER/ON_TURN/ON_USE wiring in GameCli, plus trigger action coverage test.
- Added Time Stone trap triggers (green flash reset, tick-rate curse, watch description shift), TICK_RATE world state cell, and loop tick syncing.
- Implemented Monkey Grove banana gate (rope reveal + feed/kill triggers) and tuned iPad/banana footprints to enforce the carry tradeoff.
- Added treehouse skeleton use trigger to reveal the hatchet and Scratch's ghost, plus a small fixture cell to avoid no-op use messaging.
- Implemented cave web burn state, spider relocation/death on return, and world-state tracking for the cave loop gate.
- Implemented plane wreck turn counter, warning/kill triggers, and collapse-on-exit gate teardown.
- Added raft assembly flow (bamboo poles + vine rope + parachute), escape triggers with END_GAME, and scratch-freed tracking.
- Added per-game verb alias loader (aliases.yaml) wired into CommandScanner/CommandCompiler + CLI help, plus Island alias entries and tests.
- Simplified the 2025 translator path to local-parse-first + single-pass command-only translation; removed question/color handling; updated prompt/golden tests and routing fixtures.
- Updated AI docs and the pattern index to match the command-only translator flow and single-pass orchestration.
- Simplified translator output to a single command line (no JSON) and tightened validation to the command parser only.
- Switched narrator prompting to a single template (no style overrides) and moved OpenAiNarrator to Spring AI.
- Converted CLI mini games to YAML fixtures (with backstory/crafting files) and added script-driven integration tests.
- Added mini-game playbook YAML/MD files and switched the integration test to validate per-step outputs.
- Added a BUUI ConsolePrinter utility for word-wrapping output to screen width with edge padding, plus tests.
- Wired ConsolePrinter into GameCli/NarrationService for player-facing text while keeping table renders raw.
- Added BuuiConsole helpers and routed CLI tooling output through print/printRaw to reuse ConsolePrinter.
- Added BUUI markdown rendering (tables/lists/headings) and routed `print` to detect markdown for formatted output.
- Added BUUI menu helper for CLI menus and switched GameCli to render menus via BuuiMenu.
- Added BuuiMenu prompt helper to standardize CLI menu prompts and used it for game/mini selection.
- Applied novel-style BUUI markdown formatting: paragraph indentation, centered headings, scene break markers, and bullet list dots.
- Added automatic blank lines after markdown paragraphs to improve readability between blocks.
- Added a left gutter for response text in ConsolePrinter output.
- Updated narrator fallback test expectations to include the response gutter spacing.
- Added a blank line after the game header banner before the preamble/backstory.
- Reduced repeated scene narration for action outputs by feeding a minimal scene header (location + exits) into narration.
- Added SCENE_DETAIL_LEVEL to narrator prompts to suppress extra description when only a header snapshot is available.

## Notes / Risks
- Tag sources are data-only and must be supplied explicitly; no tag inference is performed.
- Context builder uses explicit tag inputs only; tag sources still need to be wired from engine state.
- Smart-actor RAG storage/retrieval is implemented but not yet wired into runtime orchestration.
- RAG retrieval remains design-only; runtime storage/indexing and tag sources still need implementation.
- Smart actor backstory/history is data-only; runtime RAG storage/retrieval is not wired yet.
- Mansion now includes additional visible actors (suspects) in non-start plots; smart-actor roster is data-only until runtime wiring exists.
- Smart actor architecture is a planned design; no runtime wiring exists yet.
- Agent prompts under `src/main/resources/agents/` are not wired into GameCli's 2025 loop; the runbook now calls this out explicitly.
- Classic fallback only runs when AI is disabled (1980 mode or 2025 without a key) and only after the compiler fails to parse.
- Docs now point to runtime templates in `src/main/resources/agents` and role contracts in `src/main/resources/agents/`.
- Remaining alignment items are tracked in the today/tomorrow/someday list.
- Crafting now fails loudly if a crafting.yaml exists but cannot be loaded; missing files yield no recipes.
- Island loop config now lives in `loop.yaml` with a 24-hour tick budget; resets rebuild the world and keep notebook notes.
- Triggers now live in `triggers.yaml` per game and run key-expression gated actions (message, reveal/hide, cell mutation, owner move, loop reset).
- Loop runtime now mirrors `WorldState.TICK_RATE` and Island loop persists the Digital Watch description across resets.
- Castaway now starts with the backpack and core kit items, so inventory capacity reflects the iPad tradeoff.
- Verb aliases now merge per-game YAML entries with the default alias summary for CLI help output.
- Translator now emits a single command line; invalid translations surface a deterministic rephrase prompt (no question/color path).
- Translator now emits a single command line; invalid translations surface a deterministic rephrase prompt.
- Narrator prompt no longer accepts style overrides; Spring AI now drives narrator calls.
- Mini game scripts drive GameCli via reflection and require repo-path backstory files.
- Playbook fixtures define per-command expected output; the integration test maps command output segments by prompt.
- ConsolePrinter defaults to COLUMNS env/property with a small edge padding.
- ConsolePrinter preserves indentation for wrapped lines.
- BuuiConsole centralizes CLI print handling; prompts still use inline stdout writes.
- Markdown rendering supports basic tables/lists/headings/fences and strips common inline markers.
- BuuiMenu standardizes CLI menu tables with configurable headers and key width.
- BuuiMenu prompt helper defaults to quit/back labels based on the exit key.
- Markdown renderer now indents first lines, centers headings, and renders scene breaks as dot markers.
- Markdown renderer now inserts a blank line after each paragraph when the next block is non-blank.
- Response text now renders with a fixed left gutter before the wrapped lines.
- Narrator fallback expectations now include guttered lines for snapshots.
- Game header now prints with a blank line afterward for readability.
- Narration now uses a trimmed scene header for action outputs lacking exits.
- Narrator prompts now declare header-only scenes and forbid extra scene details in that mode.

## Tests / Evidence
- `mvn -q test`
- `mvn -q -Dtest=SmartActorTagLoaderTest,SmartActorContextInputBuilderTest test`
- `mvn -q -Dtest=SmartActorContextBuilderTest test`
- `mvn -q -Dtest=SmartActorHistoryStoreTest,SmartActorSpecLoaderTest test`
- `mvn -q -Dtest=GameMenuStructuredLoadTest test`
- Not run (docs only: smart actor architecture + RAG contract).
- `mvn -q -Dtest=TranslatorPromptGoldenTest,TranslatorPromptCoverageTest,TranslatorRoutingGoldenTest,PromptEvaluationHarnessTest,GameCliCraftTest,CraftingTableFlowTest test`
- `printf "1\nlook\ninventory\ncraft\nhow craft torch\nquit\n" | ./adventure --mode=1980 --quiet`
- `OPENAI_API_KEY=(from ../../.secret) ./adventure --mode=2025 --quiet` (scripted: 1, look, inventory, craft, how craft torch, quit)
- `mvn -q clean test`
- `mvn -q -Dtest=LoopRuntimeTest test`
- `mvn -q -Dtest=TriggerEngineTest test`
- `mvn -q -Dtest=LoopRuntimeTest,TriggerEngineTest,GameMenuStructuredLoadTest test`
- `mvn -q -Dtest=GameMenuStructuredLoadTest test`
- `mvn -q -Dtest=GameMenuStructuredLoadTest test`
- `mvn -q -Dtest=LoopRuntimeTest,GameMenuStructuredLoadTest test`
- `mvn -q -Dtest=TriggerEngineTest,LoopRuntimeTest,GameMenuStructuredLoadTest test`
- `mvn -q -Dtest=LoopRuntimeTest,GameMenuStructuredLoadTest test`
- `mvn -q -Dtest=CommandCompilerTest,CommandScannerTest,VerbAliasLoaderTest,GameMenuStructuredLoadTest test`
- Not run (docs-only alignment updates).
- `mvn -q -Dtest=TranslatorServiceTest,TranslationOrchestratorTest,TranslatorPromptGoldenTest,TranslatorPromptCoverageTest,PromptEvaluationHarnessTest,TranslatorRoutingGoldenTest test`
- `mvn -q -Dtest=TranslatorServiceTest,TranslationOrchestratorTest,TranslatorPromptGoldenTest,TranslatorPromptCoverageTest,PromptEvaluationHarnessTest,TranslatorRoutingGoldenTest,NarratorPromptGoldenTest,NarratorPromptSelectionTest,NarratorFallbackTest test`
- `mvn -q -Dtest=MiniGameScriptIntegrationTest test`
- `mvn -q -Dtest=MiniGamePlaybookIntegrationTest test`
- `mvn -q -Dtest=ConsolePrinterTest test`
- `mvn -q -Dtest=ConsolePrinterTest,GameCliExitFormattingTest,MiniGamePlaybookIntegrationTest test`
- `mvn -q test`
- `mvn -q -Dtest=ConsolePrinterTest,MiniGamePlaybookIntegrationTest test`
- `mvn -q -Dtest=ConsolePrinterTest,MarkdownRendererTest test`
- `mvn -q -Dtest=NarratorFallbackTest test`
- `mvn -q -Dtest=GameCliExitFormattingTest test`
- `mvn -q -Dtest=NarratorPromptGoldenTest,NarratorPromptSelectionTest test`
- `mvn -q -Dtest=MarkdownRendererTest test`
- `mvn -q -Dtest=ConsolePrinterTest,MarkdownRendererTest test`
- `mvn -q -Dtest=BuuiMenuTest test`
- `mvn -q -Dtest=ConsolePrinterTest,MarkdownRendererTest test`

## Next
- Follow the today/tomorrow/someday list in `docs/process/bujo/today-tomorrow-someday.md`.

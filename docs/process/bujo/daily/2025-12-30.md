# Daily Log â€” 2025-12-30

## What I touched
- Documented @mention conversation flow and added a conversation TODO checklist.
- Added TALK command support, @mention routing, and conversation state in the CLI/runtime.
- Wired smart-actor replies for player conversations (playerUtterance in prompt + dialogue history).
- Updated smart actor prompt for conversation replies and moved the mansion butler to the Hall.
- Added talk parsing tests and refreshed translator prompt/goldens.
- Updated design docs to describe command-specific narrator prompts and rewrite scope.
- Added narrator prompt mode + selector and refactored prompt builder to emit per-command prompt variants.
- Trimmed narrator prompt content (no global exits rules) and refreshed prompt goldens/selection tests.
- Relaxed grounding checks to be mode-aware (direction requirements) and removed action-result auto-append.
- Updated AI CLI runbook to reflect per-command narrator prompt compilation.
- Enforced literal-only narrator output with deterministic fallback when LLM output drifts.
- Removed location sentences from all narrator prompts and output normalization.
- Added exact-wording requirement to narrator prompts and bumped prompt version to v0.28.
- Updated narration tests and prompt goldens for the new literal gating.
- Added RecentAction memory in SceneNarrator and tracked last 2 canonical commands with sanitized engine output.
- Threaded recent actions into NarrationService and NarratorPromptBuilder.
- Added RECENT_ACTIONS block and rule text to narrator prompt output and updated prompt goldens/tests.
- Updated narration tests for new prompt signatures.
- Removed gate descriptions from exits list output and updated exit formatting test.
- Added look-around alias handling for "arround" and tests for the misspelling.
- Routed blocked movement through MoveResult so GoCommand narrates only the gate description and avoids duplicate messages.
- Added recent narration memory (last 2) and threaded RECENT_NARRATION into the narrator prompt.
- Added narration observer hookup in NarrationService for tracking recent outputs.
- Prefixed look-direction responses with "To the <dir>:" for clearer answers.
- Added translator direction-grounding guard to reject commands with direction tokens not present in player input.
- Updated translator prompt rules/golden and added orchestrator test for ungrounded direction outputs.
- Generalized translator grounding checks to reject any output tokens not present in player input and added identifier guard test.
- Added prompt printing hooks for all LLM callers (including gardener expanders) gated by `ai.prompts.print`.
- Enabled `AI_PROMPTS_PRINT=true` in `./adventure` startup for prompt visibility.
- Retuned narrator prompt guidance for second-person present tense, tighter cadence, and destination-name fidelity without verbatim action-result copying.
- Added EMOTE handling: translator can emit EMOTE lines, narrator prompt has emote-specific rules, and CLI routes emotes directly to narration without engine state change.
- Added emote checks with dice rolls: new DICE command, EMOTE/CHECK_REQUEST/CHECK_RESULT narration modes, and CLI routing for rolls without turn advance.
- Tightened emote/check narration rules to avoid scene-source leakage and enforce a direct roll sentence.
- Suppressed location sentences for look/inspect/listen narration and enforced look-target action results.
- Appended fixtures/items blocks from scene output into AI narration and normalized dice call spacing.
- Updated narrator prompt goldens/tests for the new location/section rules.
- Simplified narrator prompt language to enforce plain, literal wording and reduce flowery phrasing.
- Added prompt rules to strip figurative language, enforce SVO phrasing, and avoid narration paragraph breaks.
- Collapsed extra narration paragraph breaks in the AI output before appending fixtures/exits.
- Rewrote mansion/island/western/spy world descriptions to plain, literal sentences (plots, gates, fixtures, items).
- Updated Western playbook expectations for the telegraph office description.
- Relaxed narrator grounding thresholds by prompt mode and allowed emote/check paraphrases with direction-token blocking.
- Gated narrator fallback/debug messages behind the debug flag to avoid player-facing spew.
- Removed `AI_PROMPTS_PRINT=true` from `./adventure` startup to keep prompts muted by default.
- Moved "where am I/are we" handling into the translator prompt (AI mode) and removed the scanner/compiler alias + help entry.
- Added deterministic translator handling for "where am I/are we" to short-circuit to `look` without LLM calls.
- Included PLAYER_TEXT/LAST_COMMAND in narrator prompts as intent context (prompt v0.30).
- Tightened emote narration to a single sentence with no ambient/backstory drift unless in recent actions.
- Added location-question intent guidance to narrator prompts (v0.31) so "where am I" rewrites stay grounded in the scene.
- Stripped trailing `to:` destination tags from gate descriptions in look-direction and blocked-move output.
- Allowed translator grounding to accept visible fixture/item/inventory labels not present in player input.
- Updated translator prompt to permit using visible labels when the player uses a partial reference.
- Limited exits rendering to scene/room narration (not action/inspect/search turns).
- Added location-question intent guidance and tightened emote output in narrator prompt v0.32.
- Tightened translator label grounding: visible labels are only allowed when the player text shares a word with the label.
- Added deterministic translator routing for "who is <name>" to `look <name>` without LLM calls.
- Expanded @ mention resolution to allow token-prefix and unique single-token actor matches, plus mid-line mention parsing.
- Added mention resolution tests for label/key matching and ambiguity detection.
- Added InteractionState gating for dice prompts and CLI routing priority; documented deterministic input order.
- Added interaction state test for emote check + dice resolve.
- Deep clean sweep: updated runbook/architecture/README/index, clarified narration exit rules, and archived the conversation TODO list.
- Updated quit behavior: quit returns to menu; main menu quit exits program.
- Added CLI/menu tests and AI client tests to raise package coverage.
- Added RuntimeLoader/CLI helper coverage tests to push engine.cli and ai.client over 80%.

## Notes / Risks
- Conversation exit is strict: only "okay, bye" ends the session.
- Actor lookup uses deterministic token-prefix and unique single-token label matches; ambiguous mentions are rejected.
- Dialogue lines are still narrated (paraphrase possible); watch for over-editing.
- Literal gating only accepts verbatim sentences; expect fallback to deterministic output when the LLM paraphrases.
- Recent actions strip exits/items/fixtures so narration context stays grounded in engine output only.
- Prompt tests now assert RECENT_ACTIONS presence to guard the hybrid prompt format.
- Prompt logging is opt-in via config to avoid leaking dev output to players.
- InteractionState currently gates dice only; choice/confirm scaffolds remain unused.
- Narrator prompt now instructs rewrites over verbatim action results; watch for any drift in literal gate wording.
- Emote output bypasses location/exits; ensure translator grounding keeps emote text tied to player input.
- Emote check gating uses a keyword list; review if the rule set feels too strict or too permissive.
- Emote/check narration now forbids scene-source detail use; verify it yields the desired tone.
- Look-target narration now bypasses the LLM output and uses the engine action result only; watch for loss of tone.
- Scene fixtures/items are appended from raw engine output for exits-bearing scenes; ensure it matches desired list order.
- Looser grounding may allow mild paraphrase drift; monitor for new object mentions in narration.

## Tests / Evidence
- `mvn -q -Dtest=CommandCompilerTest,SmartActorRuntimeTest,TranslatorPromptGoldenTest,TranslatorPromptCoverageTest,GameMenuStructuredLoadTest test`
- `mvn -q -Dtest=NarrationServiceTest,NarratorPromptGoldenTest,NarratorPromptSelectionTest test`
- `mvn -q -Dtest=NarrationServiceTest,NarratorPromptGoldenTest,NarratorPromptSelectionTest test`
- `mvn -q -Dtest=NarrationServiceTest,NarratorFallbackTest,NarratorPromptGoldenTest,NarratorPromptSelectionTest test`
- `mvn -q -Dtest=GameCliExitFormattingTest test`
- `mvn -q -Dtest=CommandCompilerTest test`
- `mvn -q -Dtest=GoCommandTest test`
- `mvn -q -Dtest=NarrationServiceTest,NarratorFallbackTest,NarratorPromptGoldenTest,NarratorPromptSelectionTest,GoCommandTest test`
- `mvn -q -Dtest=TranslationOrchestratorTest,TranslatorPromptGoldenTest,TranslatorPromptCoverageTest test`
- `mvn -q -Dtest=TranslationOrchestratorTest,TranslatorPromptGoldenTest test`
- `mvn -q -Dtest=TranslationOrchestratorTest,TranslatorPromptGoldenTest test`
- Not run (prompt logging wiring + runbook/config update).
- Not run (adventure launcher env change).
- Not run (narrator prompt copy updates).
- `mvn -q -Dtest=TranslatorPromptGoldenTest,TranslationOrchestratorTest,TranslatorServiceTest,NarratorPromptGoldenTest,NarratorPromptSelectionTest test`
- `mvn -q -Dtest=CommandCompilerTest,CommandScannerTest,VerbAliasesTest,TranslatorPromptGoldenTest,TranslatorPromptCoverageTest,TranslatorServiceTest,TranslationOrchestratorTest,NarratorPromptGoldenTest,NarratorPromptSelectionTest,NarrationServiceTest test`
- `mvn -q -Dtest=NarratorPromptGoldenTest,NarratorPromptSelectionTest test`
- `mvn -q -Dtest=TranslatorServiceTest,MentionResolutionTest test`
- `mvn -q -Dtest=TranslatorServiceTest,MentionResolutionTest,InteractionStateTest test`
- `mvn -q -Dtest=NarrationServiceTest test`
- Not run (startup script change).
- `mvn -q -Dtest=CommandCompilerTest,CommandScannerTest test`
- `mvn -q -Dtest=TranslatorPromptGoldenTest,TranslatorPromptCoverageTest,CommandCompilerTest test`
- `mvn -q -Dtest=TranslatorPromptGoldenTest,TranslatorPromptCoverageTest,TranslatorServiceTest,NarratorPromptGoldenTest,NarratorPromptSelectionTest test`
- `mvn -q -Dtest=NarratorPromptGoldenTest,NarratorPromptSelectionTest,GoCommandTest test`
- `mvn -q -Dtest=TranslationOrchestratorTest,TranslatorPromptGoldenTest,TranslatorPromptCoverageTest test`
- `mvn -q -Dtest=NarrationServiceTest,NarratorFallbackTest,NarratorPromptGoldenTest,NarratorPromptSelectionTest,GoCommandTest test`
- `mvn -q -Dtest=NarrationServiceTest,NarratorPromptGoldenTest,NarratorPromptSelectionTest test`
- `mvn -q -Dtest=GameMenuStructuredLoadTest test`
- `mvn -q -Dtest=WesternAdventurePlaybookIntegrationTest test`
- `mvn -q -Dtest=NarratorPromptGoldenTest,NarratorPromptSelectionTest test`
- `mvn -q test`
- `mvn -q test`

## Next
- [ ] Validate narration continuity once RECENT_ACTIONS has real player data.
- [ ] Add/update narration service tests for direction-specific grounding edge cases.
- [ ] Verify fallback narration reads as a rewrite (not raw snapshot) on grounding failure.
- [ ] Review grounding tolerance with real LLM outputs and tune thresholds if needed.

# Daily Log — 2025-12-29

## What I touched
- Added a BUUI list renderer for numbered title + options output.
- Added BuuiListTest coverage for wrapping/formatting and null handling.
- Added ANSI-backed markdown styling (bold/italic/color tags) across BUUI renderers and NO_COLOR stripping.
- Updated BUUI formatting/wrapping logic + tests for ANSI-aware output.
- Documented BUUI styling markers and added BuuiMarkup helpers for color/bold/italic tags.
- Updated the AI/CLI runbook with BUUI styling usage and NO_COLOR notes.
- Added BuuiStyleDemo to render a styled sample via MarkdownRenderer.
- Mapped markdown inline/paragraph/list/table defaults through MarkdownStyleMap before ANSI encoding.
- Fixed inline markdown markers to toggle even when base styles are active (e.g., blockquotes/headers).
- Avoided trimming ANSI escape codes in list rendering by using a whitespace-only trim helper.
- Added a comprehensive markdown render test covering headings, lists, tables, code fences, and inline styles.
- Updated CLI help text to markdown and instructed narrator prompts to emit markdown-formatted output.
- Treated game preambles/backstory as narration by routing them through a markdown narration printer (blockquotes for plain text).
- Added BuuiMarkdown.render to centralize narration markdown formatting for preambles/backstory.
- Adjusted markdown rendering to split section labels from narration and keep Exits flush-left.
- Added a MarkdownScanner for deterministic markdown detection and routed narration detection through it.
- Made BuuiConsole/ConsolePrinter print() markdown-first with a new println() for plain wrapped output.
- Swapped authoring CLI outputs to println() to keep plain-text tooling clean.
- Added MarkdownCompiler + MarkdownDocument for scan/tokenize/compile pipelines, including file-based compilation support.
- Added ConsolePrinter/BuuiConsole helpers to print precompiled markdown documents.
- Added MarkdownStyleSheet + parser for CSS-like markdown styling and a default standard.style template.
- Routed MarkdownCompiler/InlineMarkdown through a style sheet so styles are configurable per render.
- Wired MarkdownStyleSheet.defaults() to load standard.style when present and otherwise render plain text.
- Enforced strict inline-color validation (inline color tags now error and are reported).
- Markdown validation errors are surfaced via ConsolePrinter stderr output.
- Routed MarkdownRenderer through MarkdownCompiler for token-based rendering.
- Tightened markdown style parsing to reject stray content and missing selectors with validation errors.
- Made standard.style loading lazy and strict, reporting invalid style sheets as markdown validation errors.
- Switched narrator raw fallbacks to println so AI-disabled output stays plain.
- Removed implicit standard.style loading; BUUI_STYLE now selects the active style file.
- Centralized layout defaults in BuuiLayout with configurable gutter/edge padding.
- Added table max-width handling with header truncation in AsciiRenderer.
- Defaulted BUUI_STYLE in the adventure launcher to standard.style when present.
- Removed blockquote indentation for narration and added a dotted gutter in printNarration.
- Adjusted narration markdown normalization to keep a single blank line between paragraphs.
- Changed narration gutter to a single bullet per paragraph (not per line).
- Rendered AI-disabled narration through markdown, stripping heading markers for scene headers/fallbacks.
- Switched exit separators to bullets and styled section labels/exit lines in standard.style.
- Defaulted ./adventure to quiet Maven output (use --verbose for logs).
- Tightened narrator prompt/footer rules and normalized AI output to always use the scene’s exact Exits line.
- Primed scene snapshots on game start so AI narrator always has exits to render.
- Limited smart-actor turns to the player’s plot in CLI to avoid long post-narration pauses.
- Gate descriptions now honor per-side YAML entries so direction looks read correctly.
- Normalized LOOK commands that start with "around" to the base LOOK action.
- Added compiler tests covering look-around normalization.
- Updated the translator prompt to route direction questions to LOOK and refreshed prompt goldens.
- Anchored narrator output to the engine’s location line and suppressed snapshot context when raw output includes exits.
- Added NarrationServiceTest coverage for location anchoring.
- Restored multi-scene fallback handling so snapshot color output survives narrator errors.
- Appended missing action results (e.g., look-direction gate descriptions) to AI narration output.
- Added NarrationServiceTest coverage for action-result inclusion.
- Focused look-target narration to location + action result using scanner tokens and updated narrator prompt guidance.
- Updated narrator prompt goldens for the look focus rule and trailing COLOR_EVENT spacing.
- Replaced the narrator template with a compiled prompt built per context (scene/action/color/look-target).
- Removed narrator prompt files from resources and updated AI runbook/skill docs.
- Simplified the compiled narrator prompt to a smaller, mode-focused contract.
- Reframed the narrator prompt as a compact “rewrite this” instruction with only key facts.

## Notes / Risks
- ANSI styling respects NO_COLOR and strips escape codes in console output.
- print() now assumes markdown input; println() preserves legacy plain wrapping for tool CLIs.
- Markdown compilation now runs off MarkdownScanner tokens; keep scanner rules aligned with renderer semantics.
- CSS-like markdown styling is applied at compile time; invalid selectors/properties throw.
- Invalid `standard.style` files now halt markdown rendering with a validation error message.
- BUUI styling now depends on BUUI_STYLE; unset means plain output.
- AI-disabled narration now renders markdown, so ANSI styles apply unless NO_COLOR is set.
- LOOK targets that begin with "around" now collapse to a plain LOOK; use quotes if an item is literally named "around".
- Narration now enforces the engine’s location line when AI output drifts.
- Multi-scene narrator errors now bypass location/exits normalization to preserve fallback narration.
- Narration now enforces action-result text when AI output omits it.
- Look-target narration now bypasses extra ambience and uses the action result verbatim.
- Narrator prompt assembly now depends on context and omits unrelated rules.
- Narrator prompt now emits a minimal rule set based on mode.
- Narrator prompt now includes only scene source, action/color blocks, and concise rewrite rules.

## Tests / Evidence
- `mvn -q -Dtest=BuuiListTest test`
- `mvn -q -Dtest=AsciiRendererTest,BuuiMenuTest,ConsolePrinterTest,ListRendererTest,MarkdownRendererTest,TextUtilsTest,InlineMarkdownTest,BuuiListTest test`
- `mvn -q -Dtest=BuuiMarkupTest test`
- `mvn -q -Dtest=InlineMarkdownTest,MarkdownRendererTest,AsciiRendererTest test` (post inline-marker fix)
- `mvn -q -Dtest=ListRendererTest,TextUtilsTest,MarkdownRendererTest,InlineMarkdownTest,AsciiRendererTest test`
- `javac -d /tmp/buui-demo src/main/java/com/demo/adventure/buui/*.java src/main/java/com/demo/adventure/buui/BuuiStyleDemo.java && java -cp /tmp/buui-demo com.demo.adventure.buui.BuuiStyleDemo` (ANSI check)
- `mvn -q -Dtest=MarkdownRendererComprehensiveTest test`
- `mvn -q -Dtest=NarratorPromptGoldenTest,NarratorPromptSelectionTest test`
- `mvn -q -Dtest=NarratorPromptGoldenTest,NarratorPromptSelectionTest test` (post rewrite prompt trim)
- `mvn -q -Dtest=ConsolePrinterTest test` (post narration blockquote)
- `mvn -q -Dtest=BuuiMarkdownTest,ConsolePrinterTest test`
- `mvn -q -Dtest=MarkdownRendererTest test`
- `mvn -q -Dtest=ConsolePrinterTest,MarkdownRendererTest,BuuiMarkdownTest test`
- `mvn -q -Dtest=MarkdownScannerTest,MarkdownCompilerTest,MarkdownRendererTest,BuuiMarkdownTest,ConsolePrinterTest test`
- `mvn -q -Dtest=MarkdownStyleSheetTest,MarkdownScannerTest,MarkdownCompilerTest,MarkdownRendererTest,InlineMarkdownTest,BuuiMarkdownTest,ConsolePrinterTest test`
- `mvn -q -Dtest=InlineMarkdownTest,MarkdownRendererTest,MarkdownRendererComprehensiveTest,MarkdownStyleSheetTest,MarkdownCompilerTest,MarkdownScannerTest,BuuiMarkdownTest,ConsolePrinterTest test`
- `mvn -q -Dtest=MarkdownStyleSheetTest,InlineMarkdownTest,MarkdownRendererTest test`
- Integration demo: invalid `standard.style` + `ConsolePrinter.print("# Style demo")` reports a markdown validation error.
- `mvn -q -Dtest=NarratorFallbackTest test`
- `mvn -q -Dtest=AsciiRendererTest,BuuiListTest,ConsolePrinterTest,MarkdownRendererTest test`
- `mvn -q -Dtest=MarkdownStyleSheetTest,InlineMarkdownTest,MarkdownRendererTest,AsciiRendererTest,ConsolePrinterTest,BuuiListTest test`
- NO_COLOR demo: `BUUI_STYLE=standard.style java -cp /tmp/buui-demo com.demo.adventure.buui.BuuiStyleDemo` vs `NO_COLOR=1 ...`
- `mvn -q -Dtest=BuuiMarkdownTest,MarkdownRendererTest,ConsolePrinterTest test`
- `mvn -q -Dtest=ConsolePrinterTest,NarratorFallbackTest,GameCliExitFormattingTest test`
- Not run (script change only).
- `mvn -q -Dtest=NarratorPromptGoldenTest,NarratorFallbackTest,NarratorPromptSelectionTest test`
- `mvn -q -Dtest=GameRuntimeCoverageTest,NarratorFallbackTest test`
- `mvn -q -Dtest=SmartActorRuntimeTest test`
- `mvn -q -Dtest=GameRuntimeCoverageTest test`
- `mvn -q -Dtest=CommandCompilerTest,TranslatorPromptGoldenTest test`
- `mvn -q -Dtest=NarrationServiceTest test`
- `mvn -q -Dtest=NarrationServiceTest,NarratorPromptGoldenTest test`
- `mvn -q -Dtest=NarrationServiceTest,NarratorPromptGoldenTest,NarratorPromptSelectionTest test`
- `mvn -q -Dtest=NarratorPromptGoldenTest,NarratorPromptSelectionTest test`
- `mvn -q -Dtest=NarratorFallbackTest,NarrationServiceTest test`
- `mvn -q -Dtest=NarrationServiceTest test`

## Next
- [ ] Consider adding a provider switch or base URL config for non-OpenAI endpoints.

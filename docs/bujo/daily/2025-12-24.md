# Daily Log — 2025-12-24

## What I touched
- Removed the mini-game menu/loader from GameCli so mini games live only in tests.
- Added per-command handler classes and a dispatcher to move CLI command logic out of the switch statement.
- Split CLI code into `engine` (cli/session/command/flow/mechanics) and `ai` packages; moved GameCli, handlers, and AI services accordingly.
- Extracted CommandContext/UseResult records and updated handlers to use the runtime context API.
- Moved command parsing into `command.interpreter` (scanner/compiler under interpreter) and updated tests/docs/scripts for new paths.
- Extracted GameRuntime/SceneNarrator/RuntimeLoader, moved command logic out of GameCli, and updated CLI tests to use runtime helpers.
- Reorganized packages into engine/domain/authoring/ai roots, including command under engine and GDL under authoring.lang.
- Moved runtime prompt templates into `src/main/resources/agents` and updated loader paths/docs.
- Removed empty legacy package directories under `src/main/java` and `src/test/java`.
- Moved `ZoneGraphBuilderTest` into `authoring/zone` to match the zone package layout.
- Relocated minigame playbooks into `src/test/resources/minigames` and updated the integration test paths.
- Removed the stale `authoring/builder` test path after the zone test relocation.
- Renamed the OpenAI translator/narrator classes to `CommandTranslator` and `NarratorService`.
- Documented the AI-assisted GDL design protocol (Adventure Vibe Coder) with role-based inputs/process/outputs.
- Added the Western Adventure GamePlan template with step-by-step inputs/process/outputs and updated the docs index.
- Added timebound game attributes and one-question interview guidance to the GamePlan protocol/template.
- Moved the GamePlan plan into the Today list for 2025-12-24.
- Defined GamePlan role contracts + output schemas and added constraints/storyteller/world planner/GDL synthesizer prompts.
- Implemented GamePlanCli orchestration with receipts for steps 1–8 and added authoring agent client + docs.
- Implemented GamePlanCli compile/validate + structured export and aligned prompts/docs/templates to the new schema.
- Added a Western Adventure playbook (YAML + MD) and integration test coverage using the structured Western game bundle.
- Renamed the authoring component to GamePlan across the CLI/docs/prompts.
- Expanded Western Adventure structure (new plots, items, fixtures, actor) and added loop/triggers for time pressure, bridge defuse, and win/lose.
- Tuned Western inventory/trigger markers (starter saddlebag + bridge signal token) and refreshed the Western playbook for the full win path.
- Expanded the Western Adventure map to 16 plots and added fixtures to populate the new locations.
- Expanded Island Adventure map to 16 plots with new side locations and gates.
- Added Island Adventure side clues and interactions for the new plots (items, fixtures, triggers).
- Updated the Western GamePlan doc to reflect the 16-plot layout and placements.
- Added an Island Adventure side-clue playbook (YAML + MD) with an integration test.
- Seeded Mansion corridor plots with clue fixtures and items, and tagged them for smart-actor context.
- Added baseline Spy Adventure fixtures, items, actors, and smart-actor specs with tags.
- Gated World Bill of Materials output behind an opt-in system property to avoid CLI debug leakage.
- Refreshed inventory from the registry after trigger outcomes to reflect moved/consumed items.
- Added Mansion/Spy end-game triggers and wired triggers.yaml into their game bundles.
- Allowed taking and inspecting items stored in open fixtures at the current plot.
- Added a Mansion Adventure playbook (YAML/MD) with an integration test for the win path.
- Disabled key-expression debug output when GameCli is constructed directly (test/CLI parity).
- Added a Mansion case board fixture plus evidence cells to clue items for pinning clues.
- Added detective case_clues tracking and tagged the case board for smart-actor context.
- Reworked Mansion triggers to pin evidence on the case board and end the game on the final pin.
- Updated the Mansion playbook (YAML/MD) to use the case board sequence.
- Removed manual case_clues increments and relied on case board evidence cell transfers for Mansion win logic.
- Ran a manual 1980 Mansion playthrough using alternate verbs/aliases (move/grab/search/explore/run) and verified the win flow.
- Verified that `examine` was not recognized without an alias file, then added Mansion verb aliases in `aliases.yaml` (EXAMINE/INVESTIGATE/PIN) and validated EXAMINE in 1980 mode.
- Added motif verb aliases for Island, Mansion, Western, and Spy (game-local `aliases.yaml`).
- Ran a 1980 Spy Adventure pass using motif verbs and confirmed alias help output + parsing.
- Ran a manual 1980 Mansion playthrough to validate the case board pinning flow end-to-end.

## Notes / Risks
- Mini games are now accessible only through integration tests; the CLI menu no longer offers them.
- Command handling now routes through the handler map; missing registrations would fall back to unknown.
- GameCli helper methods are public to support CommandContext access across `engine.cli` and `engine.session`.
- GameCli now orchestrates only; GameRuntime owns stateful command execution and turn-advance logic.
- Prompt templates now load from `src/main/resources/agents`; legacy `prompts/` folder removed.
- GamePlan structured export now expects `constraints_brief.title` to be present.
- Western playbook integration tests use `src/main/resources/games/western/game.yaml` as the load source.
- Western loop/triggers now drive clock warnings, bridge defuse state, and end-game outcomes.
- Western strongbox now fits via the starting saddlebag; bridge signal is tracked via a hidden marker item.
- Western map expansion is additive; win path and trigger logic remain unchanged.
- Island map expansion is additive; no puzzle gating or item logic changed.
- Island side clues use optional triggers and do not change the escape path.
- Mansion already exceeds 16 plots; Spy is map-only with no items/fixtures/actors yet.
- Mansion clue flow now requires pinning evidence on the case board; clues are hidden after pinning.
- Mansion win check now uses case board evidence cell counts via fixture attribute access.
- Spy is no longer map-only; it now has fixtures/items/actors plus smart-actor data.
- World build BOM output is now opt-in via `-Dadventure.bom=true` for test/debug use only.
- Trigger outcomes now resync inventory from the registry (order preserved, new items appended).
- Mansion and Spy now have explicit win triggers (no time gating yet).
- Open fixtures now expose their contained items for look/take and AI-visible item lists.
- GameCli now suppresses key-expression debug output even when main() is bypassed.

## Tests / Evidence
- `mvn -q test`
- `mvn -q -Dtest=TranslatorPromptCoverageTest,TranslatorPromptGoldenTest,NarratorPromptGoldenTest,NarratorPromptSelectionTest test`
- `mvn -q -Dtest=MiniGamePlaybookIntegrationTest test`
- `mvn -q -Dtest=TranslationOrchestratorTest,NarratorFallbackTest test`
- `mvn -q -DskipTests compile`
- `mvn -q -DskipTests compile`
- `mvn -q -Dtest=WesternAdventurePlaybookIntegrationTest test`
- `mvn -q -DskipTests compile`
- `mvn -q -Dtest=GameMenuStructuredLoadTest test`
- `mvn -q -Dtest=GameRuntimeTakeFixtureItemTest test`
- `mvn -q -Dtest=MansionAdventurePlaybookIntegrationTest test`
- `mvn -q -Dtest=GameMenuStructuredLoadTest test`
- `mvn -q -Dtest=IslandAdventurePlaybookIntegrationTest test`
- `mvn -q -Dtest=GameMenuStructuredLoadTest test`
- `mvn -q -Dtest=GameMenuStructuredLoadTest test`
- `mvn -q -Dtest=GameMenuStructuredLoadTest,WesternAdventurePlaybookIntegrationTest test`
- `printf '2\ninspect hall\nlisten\nmove west\nsearch\nmove west\ninspect study desk\nopen study desk drawer 1\ngrab basement key\ni\nmove south\ngrab ink note\nmove south\nexplore\nmove south\ngrab pressed leaf\nmove south\nrun east\ngrab glass shard\nmove east\nmove north\nmove north\nopen down\nmove down\ngrab cellar ledger\nmove up\nmove east\ngrab chalk smudge\nmove east\nmove south\ngrab torn menu\nmove north\nmove north\nmove north\nmove west\ngrab silk thread\nmove west\ninspect case board\nuse torn menu on case board\nuse glass shard with case board\nuse chalk smudge on case board\nuse pressed leaf with case board\nuse ink note on case board\nuse cellar ledger with case board\nuse silk thread on case board\nquit\n' | ./adventure --mode=1980 --quiet`
- `printf '2\nexamine case board\nquit\n' | ./adventure --mode=1980 --quiet`
- `printf '1\nscavenge\nquit\n' | ./adventure --mode=1980 --quiet`
- `printf '2\nprobe\nquit\n' | ./adventure --mode=1980 --quiet`
- `printf '3\nscout\nquit\n' | ./adventure --mode=1980 --quiet`
- `printf '4\nsurveil\nquit\n' | ./adventure --mode=1980 --quiet`
- `printf '4\nhelp\nsurveil\nsneak east\nscan\ntail west\ninfiltrate east\nhack kiosk\nquit\n' | ./adventure --mode=1980 --quiet`
- `printf '2\nlook\nwest\nwest\ntake basement key\nsouth\ntake ink note\nsouth\nsouth\ntake pressed leaf\nsouth\neast\ntake glass shard\neast\nnorth\nnorth\ndown\ntake cellar ledger\nup\neast\ntake chalk smudge\neast\nsouth\ntake torn menu\nnorth\nnorth\nnorth\nwest\ntake silk thread\nwest\nuse torn menu on case board\nuse glass shard on case board\nuse chalk smudge on case board\nuse pressed leaf on case board\nuse ink note on case board\nuse cellar ledger on case board\nuse silk thread on case board\nquit\n' | ./adventure --mode=1980 --quiet`
- `mvn -q -Dtest=GameMenuStructuredLoadTest,MansionAdventurePlaybookIntegrationTest test`
- `mvn -q -Dtest=GameMenuStructuredLoadTest,MansionAdventurePlaybookIntegrationTest test`
- `mvn -q -Dtest=WorldAssemblerPrintsBomOnSuccessTest test`
- `mvn -q -Dtest=TriggerEngineTest,GameCliCraftTest test`
- `mvn -q -Dtest=GameMenuStructuredLoadTest test`
- `mvn -q -Dtest=GameMenuStructuredLoadTest test`
- `mvn -q -Dtest=GameMenuStructuredLoadTest,WesternAdventurePlaybookIntegrationTest test`

## Next
- Follow the today/tomorrow/someday list in `docs/bujo/today-tomorrow-someday.md`.
